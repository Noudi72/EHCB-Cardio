<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intervall</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD573FQdUDS9NCbOZornq6IkWS18s5_kpM",
      authDomain: "ehcb-cardio.firebaseapp.com",
      projectId: "ehcb-cardio",
      storageBucket: "ehcb-cardio.appspot.com",
      messagingSenderId: "709040533245",
      appId: "1:709040533245:web:e7cfecc4a4b5646b689894"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const docRef = doc(db, "programme", "intervall");

    let phases = [];
    let currentPhase = -1;
    let countdown = 3;
    let timeLeft = 0;
    let timerId = null;

    const tbody = document.getElementById("tbody");

    async function loadPhases() {
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        // Automatisch generierte Struktur mit 4 Sets Ã  6x (30s hart / 15s Pause), 120s Set-Pause
        phases = [];

        // Warm-up
        phases.push({ name: "AufwÃ¤rmen", duration: 300, desc: "5 Min. locker, steigernd", rpm: "70â€“80", hf: "50â€“60" });

        for (let set = 1; set <= 4; set++) {
          for (let rep = 1; rep <= 6; rep++) {
            phases.push({ name: `Sprint ${rep} (Set ${set})`, duration: 30, desc: "Sehr hart", rpm: "100â€“110", hf: "85â€“100" });
            phases.push({ name: `Pause ${rep} (Set ${set})`, duration: 15, desc: "Sehr locker", rpm: "60â€“70", hf: "50â€“60" });
          }
          if (set < 4) {
            phases.push({ name: `Setpause ${set}`, duration: 120, desc: "Pause zwischen Sets", rpm: "60", hf: "50" });
          }
        }

        // Cool-down
        phases.push({ name: "Cooldown", duration: 600, desc: "10 Min. locker", rpm: "60", hf: "40â€“50" });

        renderTable();
      } else {
        document.getElementById("status").innerText = "Keine Daten gefunden.";
      }
    }

    function renderTable() {
      tbody.innerHTML = "";
      phases.forEach((p, i) => {
        const row = document.createElement("tr");
        row.id = "phaseRow" + i;
        row.innerHTML = `
          <td>${p.name}</td>
          <td>${p.duration}</td>
          <td>${p.desc}</td>
          <td>${p.rpm}</td>
          <td>${p.hf}</td>
          <td></td>
        `;
        tbody.appendChild(row);
      });
    }

    function highlightPhase(index) {
      phases.forEach((_, i) => {
        const row = document.getElementById("phaseRow" + i);
        if (row) row.className = i === index ? "active" : "";
      });
    }

    function startWorkout() {
      if (timerId) return;
      if (currentPhase === -1) {
        currentPhase = 0;
        timeLeft = countdown;
        document.getElementById("status").innerText = "Bereit? In 3 Sekunden geht's los...";
        highlightPhase(currentPhase);
      }
      timerId = setInterval(() => {
        document.getElementById("timer").innerText = timeLeft;
        if (timeLeft > 0) {
          timeLeft--;
        } else {
          if (countdown > 0) {
            countdown = 0;
            const p = phases[currentPhase];
            timeLeft = p.duration;
            document.getElementById("status").innerText = "Aktiv: " + p.name;
          } else {
            clearInterval(timerId);
            timerId = null;
            currentPhase++;
            countdown = 3;
            if (currentPhase < phases.length) {
              highlightPhase(currentPhase);
              timeLeft = countdown;
              document.getElementById("status").innerText = "NÃ¤chste Phase in 3 Sekunden...";
              startWorkout();
            } else {
              document.getElementById("status").innerText = "Training abgeschlossen!";
              document.getElementById("timer").innerText = "0";
              highlightPhase(-1);
            }
          }
        }
      }, 1000);
    }

    function stopWorkout() {
      clearInterval(timerId);
      timerId = null;
    }

    function resetWorkout() {
      stopWorkout();
      currentPhase = -1;
      countdown = 3;
      timeLeft = 0;
      document.getElementById("status").innerText = "Bereit";
      document.getElementById("timer").innerText = "0";
      highlightPhase(-1);
    }

    function enableCoach() {
      const pw = document.getElementById("pw").value;
      if (pw !== "ehcb2025") {
        alert("Falsches Passwort.");
        return;
      }
      tbody.querySelectorAll("tr").forEach((row, i) => {
        for (let j = 0; j < 5; j++) {
          const cell = row.children[j];
          cell.setAttribute("contenteditable", "true");
          cell.addEventListener("blur", () => {
            phases[i].name = row.children[0].innerText;
            phases[i].duration = parseInt(row.children[1].innerText);
            phases[i].desc = row.children[2].innerText;
            phases[i].rpm = row.children[3].innerText;
            phases[i].hf = row.children[4].innerText;
            savePhases();
          });
        }
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ðŸ—‘ï¸";
        deleteBtn.onclick = () => deletePhase(i);
        row.children[5].appendChild(deleteBtn);
      });

      const addBtn = document.createElement("button");
      addBtn.textContent = "âž• Phase hinzufÃ¼gen";
      addBtn.className = "button";
      addBtn.onclick = addPhase;
      document.querySelector(".coach-controls").appendChild(addBtn);

      alert("Coach-Modus aktiviert. Du kannst jetzt alle Zellen bearbeiten.");
    }

    function addPhase() {
      phases.push({ name: "Neu", duration: 30, desc: "Beschreibung", rpm: "80", hf: "70" });
      savePhases();
      renderTable();
      enableCoach();
    }

    function deletePhase(i) {
      if (confirm("Diese Phase wirklich lÃ¶schen?")) {
        phases.splice(i, 1);
        savePhases();
        renderTable();
        enableCoach();
      }
    }

    async function savePhases() {
      await setDoc(docRef, { phasen: phases });
      console.log("Daten gespeichert");
    }

    window.addEventListener("DOMContentLoaded", loadPhases);
    window.startWorkout = startWorkout;
    window.stopWorkout = stopWorkout;
    window.resetWorkout = resetWorkout;
    window.enableCoach = enableCoach;
  </script>
  <style>
    body { background: #001F4E; color: white; font-family: sans-serif; margin: 0; padding: 2rem; }
    h1 { color: #FFD700; text-align: center; margin-top: 100px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; color: black; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: center; }
    .active { background: #C80000; color: white; }
    .button { background: #C80000; color: white; padding: 0.8rem 1.5rem; margin: 1rem; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; }
    .coach-controls { margin-top: 2rem; text-align: center; }
    input[type='password'] { padding: 0.4rem; margin-right: 0.5rem; }
    #timer-bar {
      position: fixed;
      top: 0;
      width: 100%;
      background: #C80000;
      color: white;
      font-size: 2.5rem;
      padding: 1rem;
      text-align: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="timer-bar"><span id="timer">0</span> Sekunden</div>
  <h1>Intervall</h1>
  <p style="text-align:center;">4 Sets Ã  6x (30s sehr hart / 15s Pause) â€“ 120s Setpause â€“ inkl. AufwÃ¤rmen & Cooldown</p>

  <table id="phaseTable">
    <thead><tr><th>Phase</th><th>Dauer (s)</th><th>Beschreibung</th><th>RPM</th><th>% HFmax</th><th></th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>

  <p id="status">Bereit</p>
  <div style="text-align:center;">
    <button class="button" onclick="startWorkout()">Start</button>
    <button class="button" onclick="stopWorkout()">Pause</button>
    <button class="button" onclick="resetWorkout()">Reset</button>
  </div>

  <div class="coach-controls">
    <input type="password" id="pw" placeholder="Coach-Passwort" />
    <button class="button" onclick="enableCoach()">Coach-Modus starten</button>
  </div>

  <div style="text-align:center; margin-top: 2rem;">
    <a href="index.html" class="button">â¬… ZurÃ¼ck zur Startseite</a>
  </div>
</body>
</html>