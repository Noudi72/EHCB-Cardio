function startTabata() {
  document.querySelector("button[onclick='startTabata()']").style.display = "none";
  document.getElementById("tabata-timer").style.display = "block";
  document.body.style.background = "#1e1e1e";

  const prepareLabel = "PREPARE";
  const workLabel = "WORK";
  const restLabel = "REST";

  const prepareTime = parseInt(document.getElementById("prepareDuration").getAttribute("data-seconds") || document.getElementById("prepareDuration").innerText);
  const workTime = parseInt(document.getElementById("workDuration").getAttribute("data-seconds") || document.getElementById("workDuration").innerText);
  const restTime = parseInt(document.getElementById("restDuration").getAttribute("data-seconds") || document.getElementById("restDuration").innerText);
  const setPauseTime = parseInt(localStorage.getItem("setpause") || 120);

  let originalCycles = parseInt(document.getElementById("cycleCountInput").value);
  let originalTabatas = parseInt(document.getElementById("tabataCountInput").value);
  let remainingCycles = originalCycles;
  let remainingTabatas = originalTabatas;

  let tabataPhases = [];

  if (prepareTime > 0) {
    tabataPhases.push({ name: prepareLabel, duration: prepareTime });
  }

  for (let s = 0; s < originalTabatas; s++) {
    for (let i = 0; i < originalCycles; i++) {
      tabataPhases.push({ name: workLabel, duration: workTime });
      tabataPhases.push({ name: restLabel, duration: restTime });
    }
    if (s < originalTabatas - 1) {
      tabataPhases.push({ name: "Set Pause", duration: setPauseTime });
    }
  }

  let current = -1;
  let time = 0;

  tabataInterval = setInterval(() => {
    if (time === 0) {
      current++;
      if (current >= tabataPhases.length) {
        clearInterval(tabataInterval);
        tabataInterval = null;
        return;
      }

      const phase = tabataPhases[current];
      time = phase.duration;

      // Phase handling
      if (phase.name === prepareLabel) {
        soundGo.play();
        document.body.className = "";
      } else if (phase.name === workLabel) {
        document.body.className = "work";
      } else if (phase.name === restLabel) {
        document.body.className = "rest";
      } else {
        document.body.className = "setpause";
        soundGo.play();
      }

      // Update counters
      if (phase.name === workLabel) remainingCycles--;
      if (phase.name === "Set Pause") {
        remainingTabatas--;
        remainingCycles = originalCycles;
      }

      document.getElementById("cycleCountInput").value = remainingCycles;
      document.getElementById("tabataCountInput").value = remainingTabatas;
    }

    const phase = tabataPhases[current];
    if (phase) {
      if ([4, 3, 2].includes(time)) {
        if (phase.name === restLabel) {
          soundBeep.play();
        }
      } else if (time === 1) {
        if (phase.name === restLabel) {
          soundHorn.play();
        }
      }

      if (time === 4 && phase.name === workLabel) {
        soundRest.play();
      }

      // Update UI
      if (phase.name === prepareLabel) {
        document.getElementById("prepareDuration").innerText = time;
        document.getElementById("prepareDuration").style.color = "black";
      } else if (phase.name === workLabel) {
        document.getElementById("workDuration").innerText = time;
      } else if (phase.name === restLabel) {
        document.getElementById("restDuration").innerText = time;
      }
    }

    time--;
  }, 1000);
}