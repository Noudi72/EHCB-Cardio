<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EHCB Intervall Tabata</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2.1rem;
      margin-top: 1.2rem;
      color: #FFD700;
      letter-spacing: 1px;
    }
    .desc {
      margin-bottom: 1.1rem;
      color: #ccc;
      font-size: 1.1rem;
      min-height: 32px;
    }
    .tile {
      border-radius: 20px;
      margin: 0.8rem auto;
      width: 90vw;
      max-width: 375px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 2.2rem;
      font-weight: bold;
      box-shadow: 0 0 12px rgba(0,0,0,0.18);
      padding: 0.3em 1.2em;
      letter-spacing: 2px;
    }
    .tile span {
      flex: 1;
      text-align: left;
    }
    .tile .time {
      flex: 0 0 95px;
      text-align: right;
      font-size: 2.4rem;
    }
    .prepare { background: #FFD700; color: #222;}
    .work { background: #00c040; color: #fff;}
    .rest { background: #c80000; color: #fff;}
    .row {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.1rem;
      margin-bottom: 1.1rem;
    }
    .cycles, .tabatas {
      background: #fff;
      color: #111;
      border-radius: 12px;
      width: 100px;
      height: 60px;
      font-size: 1.6rem;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .label {
      font-size: 1rem;
      font-weight: normal;
      color: #222;
      margin-top: 2px;
    }
    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1em;
      margin-bottom: 1em;
    }
    .start-btn, .settings-btn, .pause-btn, .reset-btn, .setpause-btn {
      background: #d50000;
      color: #fff;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      padding: 0.6em 1.3em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      margin: 0.5em 0;
    }
    .pause-btn { background: #FFA500; color: #222;}
    .reset-btn { background: #222; color: #fff;}
    .settings-btn { background: #222; }
    .setpause-btn { background: #FFD700; color: #222; margin: 1.2em auto;}
    .setpause-popup {
      display: none;
      background: #FFD700;
      color: #222;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 18px;
      padding: 2em 1em 1em 1em;
      position: fixed;
      z-index: 9000;
      left: 50%; top: 30vh; transform: translateX(-50%);
      width: 85vw; max-width: 370px;
      box-shadow: 0 8px 40px #2227;
      text-align: center;
    }
    .setpause-popup button {
      margin-top: 1.1em;
      background: #d50000;
      color: #fff;
      border-radius: 8px;
      padding: 0.4em 2em;
      font-size: 1.1rem;
      border: none;
      cursor: pointer;
    }
    /* Modal Styles für Settings */
    .modal {
      display: none;
      position: fixed;
      z-index: 1111;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(30,30,30,0.93);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #1e1e1e;
      color: #fff;
      border-radius: 16px;
      padding: 2em 1.3em 1em 1.3em;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: 0 8px 24px #000a;
    }
    .modal-content label { display:block; margin: 0.6em 0 0.15em 0; }
    .modal-content input,
    .modal-content textarea {
      width: 90%; max-width: 360px;
      font-size: 1.05em; text-align: left;
      border-radius: 6px; border: 1px solid #888; margin-bottom: 0.5em;
      padding: 0.2em 0.4em;
      font-family: Arial, sans-serif;
    }
    .modal-content button { margin: 1.3em 0.5em 0 0.5em; }
    @media (max-width: 420px) {
      .tile { font-size: 1.1rem; }
      .tile .time { font-size: 1.1rem; }
      .cycles, .tabatas { width: 70px; height: 40px; font-size: 0.8rem;}
      .setpause-popup { font-size: 1rem;}
    }
  </style>
</head>
<body>
  <h1>Intervall Tabata</h1>
  <div class="desc" id="descText">4 Sets – 6× 30s Work / 15s Rest<br>(Warm-Up &amp; Cooldown by your own)</div>
  <!-- Timer Tiles -->
  <div class="tile prepare"><span>PREPARE</span><span class="time" id="prepareTime">03</span></div>
  <div class="tile work"><span>WORK</span><span class="time" id="workTime">30</span></div>
  <div class="tile rest"><span>REST</span><span class="time" id="restTime">15</span></div>
  <div class="row">
    <div class="cycles"><span id="cyclesVal">6</span><span class="label">CYCLES</span></div>
    <div class="tabatas"><span id="tabatasVal">4</span><span class="label">TABATAS</span></div>
  </div>
  <div class="button-row">
    <button class="start-btn" onclick="startTabata()" id="startBtn">▶ Start</button>
    <button class="pause-btn" onclick="pauseTabata()" id="pauseBtn" style="display:none;">Pause</button>
    <button class="reset-btn" onclick="resetTabata()" id="resetBtn" style="display:none;">Reset</button>
  </div>
  <button class="settings-btn" onclick="openSettings()">⚙️ Einstellungen</button>
  <button class="setpause-btn" onclick="showSetPausePopup()" id="setPauseBtn" style="display:none;">Set Pause anzeigen</button>
  <div class="setpause-popup" id="setPausePopup">
    <div>Set Pause – Bereit machen für nächsten Block!</div>
    <button onclick="hideSetPausePopup()">OK</button>
  </div>
  <!-- SETTINGS MODAL -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <label>Beschreibung (optional):<br>
        <textarea id="descTextarea" rows="2"></textarea>
      </label>
      <label>Prepare (sec): <input id="setPrepare" type="number" min="0" max="99" value="3"></label>
      <label>Work (sec): <input id="setWork" type="number" min="1" max="999" value="30"></label>
      <label>Rest (sec): <input id="setRest" type="number" min="1" max="999" value="15"></label>
      <label>Set Pause (sec): <input id="setSetPause" type="number" min="1" max="999" value="120"></label>
      <label>Cycles: <input id="setCycles" type="number" min="1" max="99" value="6"></label>
      <label>Tabatas: <input id="setTabatas" type="number" min="1" max="99" value="4"></label>
      <br>
      <button onclick="saveSettings()">✓ Übernehmen</button>
      <button onclick="closeSettings()">✗ Schließen</button>
    </div>
  </div>
  <!-- AUDIO -->
  <audio id="soundGo" src="3-2-1-Go.mp3"></audio>
  <audio id="soundRest" src="rest_2.mp3"></audio>
  <audio id="soundBeep" src="3s beep.wav"></audio>
  <script>
    let timer = null;
    let isPaused = false;
    let pausedTime = 0;
    let pausedPhase = null;
    let pausedCurrent = 0;
    let phases = [];
    let current = 0;
    let cycles = 6, tabatas = 4, prepare = 3, work = 30, rest = 15, setPause = 120;
    let curCycle = 6, curTabata = 4;
    let started = false;
    let setPauseNow = false;

    // Description editing
    const descText = document.getElementById('descText');
    const descTextarea = document.getElementById('descTextarea');
    // Load description from localStorage if available
    window.addEventListener('load', () => {
      const savedDesc = localStorage.getItem('tabataDescription');
      if(savedDesc) {
        descText.innerHTML = savedDesc.replace(/\n/g, '<br>');
        descTextarea.value = savedDesc.replace(/<br\s*\/?>/gi, '\n');
      }
    });

    function openSettings() {
      document.getElementById('settingsModal').style.display = 'flex';
      descTextarea.value = descText.innerHTML.replace(/<br\s*\/?>/gi, '\n');
      document.getElementById('setPrepare').value = prepare;
      document.getElementById('setWork').value = work;
      document.getElementById('setRest').value = rest;
      document.getElementById('setSetPause').value = setPause;
      document.getElementById('setCycles').value = cycles;
      document.getElementById('setTabatas').value = tabatas;
    }
    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }
    function saveSettings() {
      // Beschreibung
      let val = descTextarea.value.trim();
      if(val === '') val = '4 Sets – 6× 30s Work / 15s Rest (Warm-Up & Cooldown by your own)';
      descText.innerHTML = val.replace(/\n/g, '<br>');
      localStorage.setItem('tabataDescription', descText.innerHTML);
      // Zeiten
      prepare = parseInt(document.getElementById('setPrepare').value);
      work = parseInt(document.getElementById('setWork').value);
      rest = parseInt(document.getElementById('setRest').value);
      setPause = parseInt(document.getElementById('setSetPause').value);
      cycles = parseInt(document.getElementById('setCycles').value);
      tabatas = parseInt(document.getElementById('setTabatas').value);
      document.getElementById('prepareTime').textContent = prepare < 10 ? '0'+prepare : prepare;
      document.getElementById('workTime').textContent = work;
      document.getElementById('restTime').textContent = rest;
      // Reset curCycle and curTabata to full counts on settings save
      curCycle = cycles;
      curTabata = tabatas;
      document.getElementById('cyclesVal').textContent = curCycle;
      document.getElementById('tabatasVal').textContent = curTabata;
      closeSettings();
    }
    function updateCounts(){
      document.getElementById('cyclesVal').textContent = curCycle >= 0 ? curCycle : 0;
      document.getElementById('tabatasVal').textContent = curTabata >= 0 ? curTabata : 0;
    }
    function showPhase(type, value){
      document.getElementById('prepareTime').textContent = type=='PREPARE' ? (value<10?'0'+value:value) : (prepare<10?'0'+prepare:prepare);
      document.getElementById('workTime').textContent = type=='WORK' ? value : work;
      document.getElementById('restTime').textContent = type=='REST' ? value : rest;
      document.querySelector('.prepare').style.opacity = (type=='PREPARE') ? 1 : 0.7;
      document.querySelector('.work').style.opacity = (type=='WORK') ? 1 : 0.7;
      document.querySelector('.rest').style.opacity = (type=='REST') ? 1 : 0.7;
    }
    function startTabata() {
      started = true;
      isPaused = false;
      setPauseNow = false;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('pauseBtn').style.display = '';
      document.getElementById('resetBtn').style.display = '';
      document.getElementById('setPauseBtn').style.display = '';
      curCycle = cycles;
      curTabata = tabatas;
      updateCounts();
      // Phasenaufbau (Rest nach letztem Work entfällt!)
      phases = [];
      if (prepare > 0) phases.push({type:'PREPARE', duration:prepare});
      for(let t=1; t<=tabatas; t++){
        for(let c=1; c<=cycles; c++){
          phases.push({type:'WORK', duration:work});
          // Nur Rest, wenn es nicht der letzte Cycle dieses Sets ist!
          if(c < cycles) phases.push({type:'REST', duration:rest});
        }
        if(t<tabatas) phases.push({type:'SET PAUSE', duration:setPause});
        // Nach Set Pause optional Prepare für nächsten Block
        // phases.push({type:'PREPARE', duration:prepare});
      }
      current = 0;
      nextPhase();
    }

    function playGo() { document.getElementById('soundGo').play(); }
    function playRest() { document.getElementById('soundRest').play(); }
    function playBeep() { document.getElementById('soundBeep').play(); }

    function nextPhase(){
      if (current>=phases.length) {
        showPhase('', 0);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        document.getElementById('setPauseBtn').style.display = 'none';
        started = false;
        return;
      }
      let phase = phases[current];
      let t = phase.duration;
      showPhase(phase.type, t);
      // Prepare-Ton: Go kommt bei t==4 (4,3,2,1) – für 3-2-1-go
      timer = setInterval(()=>{
        showPhase(phase.type, t);
        if(phase.type=='PREPARE' && (t==4||t==3||t==2||t==1)) playGo();
        // Countdown-Beep nur in letzten 3 Sekunden bei Work und Rest
        if((phase.type=='WORK'||phase.type=='REST') && t<=3 && t>0) playBeep();
        if(t==0 && phase.type=='WORK') playRest(); // Signal für Pause
        if(t==0 && phase.type=='REST') playRest(); // Signal für Wieder-Einstieg
        t--;
        if (t<0) {
          clearInterval(timer);
          // Cycles und Tabatas zählen (down-count)
          if(phase.type=='WORK'){
            if(curCycle > 1) curCycle--;
            else if(curCycle === 1) curCycle = 0;
          }
          if(phase.type=='SET PAUSE') {
            if(curTabata > 1) curTabata--;
            else if(curTabata === 1) curTabata = 0;
            curCycle = cycles;
          }
          updateCounts();
          current++;
          if(!isPaused) nextPhase();
        }
      },1000);
    }

    function pauseTabata() {
      if (!started) return;
      if (!isPaused) {
        clearInterval(timer);
        isPaused = true;
        document.getElementById('pauseBtn').textContent = 'Fortsetzen';
      } else {
        isPaused = false;
        document.getElementById('pauseBtn').textContent = 'Pause';
        nextPhase();
      }
    }
    function resetTabata() {
      clearInterval(timer);
      isPaused = false;
      started = false;
      setPauseNow = false;
      document.getElementById('pauseBtn').textContent = 'Pause';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('setPauseBtn').style.display = 'none';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('prepareTime').textContent = prepare < 10 ? '0'+prepare : prepare;
      document.getElementById('workTime').textContent = work;
      document.getElementById('restTime').textContent = rest;
      curCycle = cycles;
      curTabata = tabatas;
      document.getElementById('cyclesVal').textContent = curCycle;
      document.getElementById('tabatasVal').textContent = curTabata;
      current = 0;
      updateCounts();
    }
    // Set Pause Button
    function showSetPausePopup() {
      document.getElementById('setPausePopup').style.display = 'block';
    }
    function hideSetPausePopup() {
      document.getElementById('setPausePopup').style.display = 'none';
    }
  </script>
</body>
</html>