<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EHCB Intervall Tabata</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .logo {
      width: 92px;
      max-width: 24vw;
      margin: 1.2rem auto 0.3rem auto;
      display: block;
      border-radius: 16px;
      box-shadow: 0 2px 8px #0006;
      background: #fff;
    }
    h1 {
      font-size: 2.1rem;
      margin-top: 0.3rem;
      color: #FFD700;
      letter-spacing: 1px;
    }
    .desc {
      margin-bottom: 1.1rem;
      color: #ccc;
      font-size: 1.1rem;
      min-height: 32px;
    }
    .tile {
      border-radius: 20px;
      margin: 0.8rem auto;
      width: 90vw;
      max-width: 375px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 2.2rem;
      font-weight: bold;
      box-shadow: 0 0 12px rgba(0,0,0,0.18);
      padding: 0.3em 1.2em;
      letter-spacing: 2px;
      opacity: 0.6;
      filter: grayscale(0.12);
      transition: opacity 0.25s, filter 0.25s;
    }
    .tile.active {
      opacity: 1;
      filter: none;
    }
    .tile span {
      flex: 1;
      text-align: left;
    }
    .tile .time {
      flex: 0 0 95px;
      text-align: right;
      font-size: 2.4rem;
    }
    .prepare { background: #FFD700; color: #222;}
    .work { background: #00c040; color: #fff;}
    .rest { background: #c80000; color: #fff;}
    .setpause { background: #FFD700; color: #222;}
    .row {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.1rem;
      margin-bottom: 1.1rem;
    }
    .cycles, .tabatas {
      background: #fff;
      color: #111;
      border-radius: 12px;
      width: 100px;
      height: 60px;
      font-size: 1.6rem;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .label {
      font-size: 1rem;
      font-weight: normal;
      color: #222;
      margin-top: 2px;
    }
    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1em;
      margin-bottom: 1em;
    }
    .start-btn, .settings-btn, .pause-btn, .reset-btn {
      background: #d50000;
      color: #fff;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      padding: 0.6em 1.3em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      margin: 0.5em 0;
    }
    .pause-btn { background: #FFA500; color: #222;}
    .reset-btn { background: #222; color: #fff;}
    .settings-btn { background: #222; }
    /* Modal Styles für Settings */
    .modal {
      display: none;
      position: fixed;
      z-index: 1111;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(30,30,30,0.93);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #1e1e1e;
      color: #fff;
      border-radius: 16px;
      max-width: 400px;
      width: 96vw;
      max-height: 90vh;
      overflow-y: auto;
      margin: 0 auto;
      box-shadow: 0 8px 24px #000a;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      padding-bottom: 2.5em;
    }
    .modal-content label { display:block; margin: 0.6em 0 0.15em 0; }
    .modal-content input,
    .modal-content textarea {
      width: 95%; max-width: 360px;
      font-size: 1.05em; text-align: left;
      border-radius: 6px; border: 1px solid #888; margin-bottom: 0.5em;
      padding: 0.2em 0.4em;
      font-family: Arial, sans-serif;
    }
    .modal-content .modal-buttons {
      display: flex;
      position: sticky;
      bottom: 0; left: 0;
      background: #1e1e1e;
      gap: 1em;
      justify-content: center;
      padding: 0.8em 0 0.5em 0;
    }
    @media (max-width: 420px) {
      .tile { font-size: 1.1rem; }
      .tile .time { font-size: 1.1rem; }
      .cycles, .tabatas { width: 70px; height: 40px; font-size: 0.8rem;}
      .logo { max-width: 44vw; }
    }
  </style>
</head>
<body>
  <img src="icon-cardio.png" class="logo" alt="Cardio Logo" />
  <h1>Intervall Tabata</h1>
  <div class="desc" id="descText">4 Sets – 6× 30s Work / 15s Rest<br>(Warm-Up &amp; Cooldown by your own)</div>
  <div class="tile prepare active" id="tilePrepare"><span>PREPARE</span><span class="time" id="prepareTime">03</span></div>
  <div class="tile work" id="tileWork"><span>WORK</span><span class="time" id="workTime">30</span></div>
  <div class="tile rest" id="tileRest"><span>REST</span><span class="time" id="restTime">15</span></div>
  <div class="tile setpause" id="tileSetPause"><span>SET PAUSE</span><span class="time" id="setPauseTime">120</span></div>
  <div class="row">
    <div class="cycles"><span id="cyclesVal">6</span><span class="label">CYCLES</span></div>
    <div class="tabatas"><span id="tabatasVal">4</span><span class="label">TABATAS</span></div>
  </div>
  <div class="button-row">
    <button class="start-btn" onclick="startTabata()" id="startBtn">▶ Start</button>
    <button class="pause-btn" onclick="pauseTabata()" id="pauseBtn" style="display:none;">Pause</button>
    <button class="reset-btn" onclick="resetTabata()" id="resetBtn" style="display:none;">Reset</button>
  </div>
  <button class="settings-btn" onclick="openSettings()">⚙️ Einstellungen</button>
  <!-- SETTINGS MODAL -->
  <div class="modal" id="settingsModal">
    <form class="modal-content" onsubmit="saveSettings();return false;">
      <label>Beschreibung (optional):<br>
        <textarea id="descTextarea" rows="2"></textarea>
      </label>
      <label>Prepare (sec): <input id="setPrepare" type="number" min="0" max="99" value="3"></label>
      <label>Work (sec): <input id="setWork" type="number" min="1" max="999" value="30"></label>
      <label>Rest (sec): <input id="setRest" type="number" min="1" max="999" value="15"></label>
      <label>Set Pause (sec): <input id="setSetPause" type="number" min="1" max="999" value="120"></label>
      <label>Cycles: <input id="setCycles" type="number" min="1" max="99" value="6"></label>
      <label>Tabatas: <input id="setTabatas" type="number" min="1" max="99" value="4"></label>
      <div class="modal-buttons">
        <button type="submit">✓ Übernehmen</button>
        <button type="button" onclick="closeSettings()">✗ Schließen</button>
      </div>
    </form>
  </div>
  <!-- AUDIO -->
  <audio id="soundGo" src="3-2-1-Go.mp3"></audio>
  <audio id="soundBeep" src="beep.wav"></audio>
  <audio id="soundRest" src="rest_2.mp3"></audio>
  <script>
    // Variablen für den Timer
    let timer = null;
    let state = "prepare";
    let running = false;
    let paused = false;
    let currentCycle = 1, totalCycles = 6;
    let currentTabata = 1, totalTabatas = 4;
    let tPrepare = 3, tWork = 30, tRest = 15, tSetPause = 120;
    let t = tPrepare;
    let settings = {};
    // Audio Elemente
    const soundGo = document.getElementById("soundGo");
    const soundBeep = document.getElementById("soundBeep");
    const soundRest = document.getElementById("soundRest");
    // Initialisieren (Settings aus localStorage)
    window.onload = function() {
      if(localStorage.getItem("tabataSettings")) {
        settings = JSON.parse(localStorage.getItem("tabataSettings"));
        loadSettings();
      }
      updateTiles();
    };
function startTabata() {
  // "Audio Unlock" für Safari/iOS/Mac
  [soundGo, soundBeep, soundRest].forEach(a => {
    try {
      a.volume = 0;
      a.play().then(()=>{a.pause();a.currentTime=0;a.volume=1;});
    } catch(e){}
  });

  document.getElementById("startBtn").style.display = "none";
  document.getElementById("pauseBtn").style.display = "";
  document.getElementById("resetBtn").style.display = "";
  paused = false;
  running = true;
      // Werte holen
      tPrepare = parseInt(document.getElementById("prepareTime").innerText);
      tWork = parseInt(document.getElementById("workTime").innerText);
      tRest = parseInt(document.getElementById("restTime").innerText);
      tSetPause = parseInt(document.getElementById("setPauseTime").innerText);
      totalCycles = parseInt(document.getElementById("cyclesVal").innerText);
      totalTabatas = parseInt(document.getElementById("tabatasVal").innerText);
      // State initialisieren
      state = "prepare";
      currentCycle = 1;
      currentTabata = 1;
      updateTiles();
      t = tPrepare;
      playGo(); // Startsignal
      timer = setInterval(step, 1000);
    }
    function pauseTabata() {
      if(paused) {
        paused = false;
        document.getElementById("pauseBtn").textContent = "Pause";
        timer = setInterval(step, 1000);
      } else {
        paused = true;
        document.getElementById("pauseBtn").textContent = "Weiter";
        clearInterval(timer);
      }
    }
    function resetTabata() {
      clearInterval(timer);
      running = false; paused = false;
      document.getElementById("startBtn").style.display = "";
      document.getElementById("pauseBtn").style.display = "none";
      document.getElementById("resetBtn").style.display = "none";
      state = "prepare";
      currentCycle = 1;
      currentTabata = 1;
      t = tPrepare;
      updateTiles();
    }
    function step() {
  if (paused) return;
  t--;

  // Countdown-Beep in letzten 3 Sekunden für Work, Rest, Setpause
  if (t <= 3 && t > 0 && (state === "work" || state === "rest" || state === "setpause")) playBeep();

  if (t === 0) {
    // PHASEN-ÜBERGANG
    if (state === "prepare") {
      t = tWork;
      state = "work";
      activateTile("work");
    } else if (state === "work") {
      // Prüfen, ob dies der letzte Cycle in der Tabata ist
      if (currentCycle < totalCycles) {
        playRest();
        t = tRest;
        state = "rest";
        activateTile("rest");
      } else {
        // Letzter Cycle: Kein Rest mehr, sondern direkt in Set Pause oder Ende
        if (currentTabata < totalTabatas) {
          // KEIN playGo() hier!
          currentTabata++;
          currentCycle = 1;
          t = tSetPause;
          state = "setpause";
          activateTile("setpause");
        } else {
          stopTabata(); // FERTIG!
          return;
        }
      }
    } else if (state === "rest") {
      currentCycle++;
      t = tWork;
      state = "work";
      activateTile("work");
    } else if (state === "setpause") {
      t = tPrepare;
      state = "prepare";
      activateTile("prepare");
      playGo(); // Startsignal jetzt HIER, nach Set Pause!
    }
  }
  updateTiles();
}
    function stopTabata() {
      clearInterval(timer);
      running = false;
      document.getElementById("startBtn").style.display = "";
      document.getElementById("pauseBtn").style.display = "none";
      document.getElementById("resetBtn").style.display = "none";
      state = "prepare";
      t = tPrepare;
      currentCycle = 1;
      currentTabata = 1;
      updateTiles();
    }
    function activateTile(tile) {
      document.getElementById("tilePrepare").classList.remove("active");
      document.getElementById("tileWork").classList.remove("active");
      document.getElementById("tileRest").classList.remove("active");
      document.getElementById("tileSetPause").classList.remove("active");
      if(tile==="prepare") document.getElementById("tilePrepare").classList.add("active");
      if(tile==="work") document.getElementById("tileWork").classList.add("active");
      if(tile==="rest") document.getElementById("tileRest").classList.add("active");
      if(tile==="setpause") document.getElementById("tileSetPause").classList.add("active");
    }
    function updateTiles() {
      document.getElementById("prepareTime").innerText = pad(tPrepare);
      document.getElementById("workTime").innerText = pad(tWork);
      document.getElementById("restTime").innerText = pad(tRest);
      document.getElementById("setPauseTime").innerText = pad(tSetPause);
      document.getElementById("cyclesVal").innerText = totalCycles-(currentCycle-1);
      document.getElementById("tabatasVal").innerText = totalTabatas-(currentTabata-1);
      // Highlight Active
      activateTile(state);
      // Countdowns in Tile
      if(running) {
        if(state==="prepare") document.getElementById("prepareTime").innerText = pad(t);
        if(state==="work") document.getElementById("workTime").innerText = pad(t);
        if(state==="rest") document.getElementById("restTime").innerText = pad(t);
        if(state==="setpause") document.getElementById("setPauseTime").innerText = pad(t);
      }
    }
    function pad(val) {
      return val<10?"0"+val:val;
    }
    // --- AUDIO ---
    function playGo() {
  try {
    soundGo.pause();
    soundGo.currentTime = 0;
    soundGo.volume = 1;
    setTimeout(()=>soundGo.play().catch(()=>{}), 40);
  } catch(e){}
}
function playBeep() {
  try {
    soundBeep.pause();
    soundBeep.currentTime = 0;
    soundBeep.volume = 1;
    setTimeout(()=>soundBeep.play().catch(()=>{}), 40);
  } catch(e){}
}
function playRest() {
  try {
    soundRest.pause();
    soundRest.currentTime = 0;
    soundRest.volume = 1;
    setTimeout(()=>soundRest.play().catch(()=>{}), 60);
  } catch(e){}
}
    // --- SETTINGS MODAL ---
    function openSettings() {
      document.getElementById("descTextarea").value = document.getElementById("descText").innerText.replace('\n', '');
      document.getElementById("setPrepare").value = tPrepare;
      document.getElementById("setWork").value = tWork;
      document.getElementById("setRest").value = tRest;
      document.getElementById("setSetPause").value = tSetPause;
      document.getElementById("setCycles").value = totalCycles;
      document.getElementById("setTabatas").value = totalTabatas;
      document.getElementById("settingsModal").style.display = "flex";
    }
    function closeSettings() {
      document.getElementById("settingsModal").style.display = "none";
    }
    function saveSettings() {
      // Werte übernehmen
      tPrepare = parseInt(document.getElementById("setPrepare").value);
      tWork = parseInt(document.getElementById("setWork").value);
      tRest = parseInt(document.getElementById("setRest").value);
      tSetPause = parseInt(document.getElementById("setSetPause").value);
      totalCycles = parseInt(document.getElementById("setCycles").value);
      totalTabatas = parseInt(document.getElementById("setTabatas").value);
      document.getElementById("prepareTime").innerText = pad(tPrepare);
      document.getElementById("workTime").innerText = pad(tWork);
      document.getElementById("restTime").innerText = pad(tRest);
      document.getElementById("setPauseTime").innerText = pad(tSetPause);
      document.getElementById("cyclesVal").innerText = totalCycles;
      document.getElementById("tabatasVal").innerText = totalTabatas;
      // Beschreibung speichern
      document.getElementById("descText").innerText = document.getElementById("descTextarea").value;
      // Save localStorage
      settings = {
        tPrepare, tWork, tRest, tSetPause,
        totalCycles, totalTabatas,
        desc: document.getElementById("descTextarea").value
      };
      localStorage.setItem("tabataSettings", JSON.stringify(settings));
      closeSettings();
      resetTabata();
    }
    function loadSettings() {
      if(settings.tPrepare) tPrepare = settings.tPrepare;
      if(settings.tWork) tWork = settings.tWork;
      if(settings.tRest) tRest = settings.tRest;
      if(settings.tSetPause) tSetPause = settings.tSetPause;
      if(settings.totalCycles) totalCycles = settings.totalCycles;
      if(settings.totalTabatas) totalTabatas = settings.totalTabatas;
      document.getElementById("prepareTime").innerText = pad(tPrepare);
      document.getElementById("workTime").innerText = pad(tWork);
      document.getElementById("restTime").innerText = pad(tRest);
      document.getElementById("setPauseTime").innerText = pad(tSetPause);
      document.getElementById("cyclesVal").innerText = totalCycles;
      document.getElementById("tabatasVal").innerText = totalTabatas;
      if(settings.desc) document.getElementById("descText").innerText = settings.desc;
    }
    // Modal close outside click
    window.onclick = function(e){
      if(e.target===document.getElementById("settingsModal")) closeSettings();
    };
  </script>
</body>
</html>